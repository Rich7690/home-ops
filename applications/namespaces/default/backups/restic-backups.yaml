---
apiVersion: batch/v1
kind: CronJob
metadata:
    labels:
        app: weekly-script
    name: weekly-script
    namespace: cron
spec:
    concurrencyPolicy: Forbid
    failedJobsHistoryLimit: 1
    jobTemplate:
        metadata:
            labels:
                app: weekly-script
            name: weekly-script
        spec:
            backoffLimit: 0
            completions: 1
            manualSelector: false
            parallelism: 1
            template:
                metadata:
                    labels:
                        app: weekly-script
                    name: weekly-script
                spec:
                    securityContext:
                      runAsUser: 0
                      runAsGroup: 0
                      runAsNonRoot: false
                      fsGroup: 0
                    automountServiceAccountToken: true
                    containers:
                        - args:
                              - --
                              - /bin/weekly_script.sh
                          command:
                              - /bin/runitor
                          env:
                              - name: TZ
                                value: America/Los_Angeles
                              - name: CHECK_UUID
                                valueFrom:
                                    secretKeyRef:
                                        key: weekly-script-uuid
                                        name: backups
                                        optional: false
                          image: ghcr.io/rich7690/restic-backup-docker:latest@sha256:053b77f7f26a38c770f38a417629615e9d721b809417e65ac8d9c6b99e389136
                          imagePullPolicy: IfNotPresent
                          name: restic
                          resources:
                              limits:
                                  cpu: "16"
                                  memory: 16G
                              requests:
                                  cpu: "2"
                                  memory: 1G
                          terminationMessagePath: /dev/termination-log
                          terminationMessagePolicy: File
                          volumeMounts:
                              - mountPath: /storage
                                mountPropagation: None
                                name: storage
                              - mountPath: /backup
                                mountPropagation: None
                                name: backup
                              - mountPath: /config/
                                mountPropagation: None
                                name: excludes-file
                                readOnly: true
                              - mountPath: /secrets/
                                name: passfile
                                readOnly: true
                    dnsConfig:
                        options:
                            - name: ndots
                              value: "3"
                        searches:
                            - default.svc.cluster.local
                    dnsPolicy: ClusterFirst
                    enableServiceLinks: true
                    hostname: debian-server-restic
                    nodeSelector:
                        kubernetes.io/hostname: virtworkerone
                    restartPolicy: Never
                    schedulerName: default-scheduler
                    shareProcessNamespace: false
                    serviceAccountName: cron
                    terminationGracePeriodSeconds: 30
                    volumes:
                        - configMap:
                              defaultMode: 420
                              name: excludes-file
                              optional: false
                          name: excludes-file
                        - hostPath:
                              path: /var/mnt/cache
                          name: storage
                        - persistentVolumeClaim:
                              claimName: backup-nfs
                          name: backup
                        - name: passfile
                          secret:
                              secretName: backups

    schedule: 0 1 * * SUN
    successfulJobsHistoryLimit: 1
    suspend: false
---
apiVersion: batch/v1
kind: CronJob
metadata:
    labels:
        app: weekly-prune
    name: weekly-prune
    namespace: cron
spec:
    concurrencyPolicy: Forbid
    failedJobsHistoryLimit: 1
    jobTemplate:
        metadata:
            annotations:
                diun.enable: "false"
            labels:
                app: weekly-prune
            name: weekly-prune
        spec:
            backoffLimit: 5
            completions: 1
            manualSelector: false
            parallelism: 1
            template:
                metadata:
                    labels:
                        app: weekly-prune
                    name: weekly-prune
                spec:
                    securityContext:
                      runAsUser: 0
                      runAsGroup: 0
                      runAsNonRoot: false
                      fsGroup: 0
                    automountServiceAccountToken: true
                    containers:
                        - args:
                              - --
                              - /bin/weekly_prune.sh
                          command:
                              - /bin/runitor
                          env:
                              - name: TZ
                                value: America/Los_Angeles
                              - name: CHECK_UUID
                                valueFrom:
                                    secretKeyRef:
                                        key: weekly-prune-uuid
                                        name: backups
                                        optional: false
                          image: ghcr.io/rich7690/restic-backup-docker:latest@sha256:053b77f7f26a38c770f38a417629615e9d721b809417e65ac8d9c6b99e389136
                          imagePullPolicy: IfNotPresent
                          name: restic
                          resources:
                              limits:
                                  cpu: "16"
                                  memory: 16G
                              requests:
                                  cpu: "2"
                                  memory: 1G
                          terminationMessagePath: /dev/termination-log
                          terminationMessagePolicy: File
                          volumeMounts:
                              - mountPath: /storage
                                mountPropagation: None
                                name: backup # temporary hack until I rebuild the image
                              - mountPath: /backup
                                mountPropagation: None
                                name: backup
                              - mountPath: /config/
                                mountPropagation: None
                                name: excludes-file
                                readOnly: true
                              - mountPath: /secrets/
                                name: passfile
                                readOnly: true
                    dnsConfig:
                        options:
                            - name: ndots
                              value: "3"
                        searches:
                            - default.svc.cluster.local
                    dnsPolicy: ClusterFirst
                    enableServiceLinks: true
                    hostname: debian-server-restic
                    nodeSelector:
                        kubernetes.io/hostname: virtworkerone
                    restartPolicy: Never
                    schedulerName: default-scheduler
                    shareProcessNamespace: false
                    serviceAccountName: cron
                    terminationGracePeriodSeconds: 30
                    volumes:
                        - configMap:
                              defaultMode: 420
                              name: excludes-file
                              optional: false
                          name: excludes-file
                        - persistentVolumeClaim:
                              claimName: backup-nfs
                          name: backup
                        - name: passfile
                          secret:
                              secretName: backups
    schedule: 0 1 * * TUE
    successfulJobsHistoryLimit: 1
    suspend: false
---
kind: ServiceAccount
apiVersion: v1
metadata:
    name: cron
    namespace: cron
secrets:
    - name: cron-sa-token
automountServiceAccountToken: true
---
apiVersion: v1
kind: Secret
metadata:
    name: cron-sa-token
    namespace: cron
    annotations:
        kubernetes.io/service-account.name: cron
type: kubernetes.io/service-account-token
