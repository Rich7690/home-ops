---
apiVersion: apps/v1
kind: StatefulSet
metadata:
    labels:
        app: jelly
    name: jelly
    namespace: default
spec:
    serviceName: jelly
    replicas: 1
    revisionHistoryLimit: 3
    podManagementPolicy: Parallel
    selector:
        matchLabels:
            app: jelly
    template:
        metadata:
            labels:
                app: jelly
        spec:
            automountServiceAccountToken: true
            containers:
                - securityContext:
                      allowPrivilegeEscalation: false
                      capabilities:
                          drop:
                              - ALL
                      privileged: false
                      readOnlyRootFilesystem: false
                      runAsGroup: 997
                      runAsNonRoot: true
                      runAsUser: 998
                  env:
                      - name: JELLYFIN_CONFIG_DIR
                        value: /config
                      - name: JELLYFIN_DATA_DIR
                        value: /config/data
                  image: jellyfin/jellyfin:10.8.9@sha256:4e488bbc7f39708851286f7f85adfff00e07df896cbacab21366a854666d7b9c
                  imagePullPolicy: IfNotPresent
                  livenessProbe:
                      failureThreshold: 3
                      httpGet:
                          path: /health
                          port: 8096
                          scheme: HTTP
                      initialDelaySeconds: 15
                      periodSeconds: 10
                      successThreshold: 1
                      timeoutSeconds: 1
                  name: jelly
                  ports:
                      - containerPort: 8096
                        name: http
                        protocol: TCP
                  readinessProbe:
                      failureThreshold: 3
                      httpGet:
                          path: /health
                          port: 8096
                          scheme: HTTP
                      initialDelaySeconds: 15
                      periodSeconds: 10
                      successThreshold: 1
                      timeoutSeconds: 1
                  resources:
                      limits:
                          gpu.intel.com/i915: 1
                          cpu: "12"
                          memory: 4Gi
                      requests:
                          gpu.intel.com/i915: 1
                          cpu: "1"
                          memory: 2Gi
                  terminationMessagePath: /dev/termination-log
                  terminationMessagePolicy: File
                  volumeMounts:
                      - mountPath: /config
                        mountPropagation: None
                        subPath: configs/jelly
                        name: config
                      - mountPath: /media
                        mountPropagation: None
                        name: media
            dnsPolicy: ClusterFirst
            enableServiceLinks: true
            nodeSelector:
                feature.node.ceph: "true"
                intel.feature.node.kubernetes.io/gpu: "true"
            restartPolicy: Always
            schedulerName: default-scheduler
            securityContext:
                fsGroup: 997
                fsGroupChangePolicy: OnRootMismatch
            shareProcessNamespace: false
            terminationGracePeriodSeconds: 30
            volumes:
                - persistentVolumeClaim:
                    claimName: cache-pvc
                  name: config
                - name: media
                  persistentVolumeClaim:
                      claimName: media-pvc
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
    name: jellyfin
    namespace: default
spec:
    podSelector:
        matchLabels:
            app: jelly
    ingress:
        - from:
              - podSelector: {}
    egress:
        - to:
              - ipBlock:
                    cidr: 0.0.0.0/0 # jellyfin can call out to internet for certain things, but it shouldn't access our local network ever
                    except:
                        #- 10.0.0.0/8 TODO: this blocks kubernetes subnets
                        - 192.168.0.0/16
                        - 172.16.0.0/12
        - to:
              - namespaceSelector: {}
                podSelector:
                    matchLabels:
                        k8s-app: kube-dns
          ports:
              - port: 53
                protocol: UDP
---
apiVersion: v1
kind: Service
metadata:
    labels:
        app: jelly
    name: jelly
    namespace: default
spec:
    internalTrafficPolicy: Cluster
    ipFamilies:
        - IPv4
    ipFamilyPolicy: SingleStack
    ports:
        - name: http
          port: 80
          protocol: TCP
          targetPort: http
    selector:
        app: jelly
    sessionAffinity: None
    type: ClusterIP
