---
apiVersion: apps/v1
kind: StatefulSet
metadata:
    labels:
        app: jelly
    name: jelly
    namespace: default
spec:
    serviceName: jelly
    replicas: 1
    revisionHistoryLimit: 3
    podManagementPolicy: Parallel
    selector:
        matchLabels:
            app: jelly
    template:
        metadata:
            labels:
                app: jelly
        spec:
            automountServiceAccountToken: true
            containers:
                - securityContext:
                      allowPrivilegeEscalation: false
                      capabilities:
                          drop:
                              - ALL
                      privileged: false
                      readOnlyRootFilesystem: false
                      runAsGroup: 997
                      runAsNonRoot: true
                      runAsUser: 998
                  env:
                      - name: JELLYFIN_CONFIG_DIR
                        value: /config
                      - name: JELLYFIN_DATA_DIR
                        value: /config/data
                  image: jellyfin/jellyfin:10.8.11@sha256:d39f8826c0e48b08770b735ab0342c9cb9fc08c59777f41080c76549526fd667
                  imagePullPolicy: IfNotPresent
                  livenessProbe:
                      failureThreshold: 3
                      httpGet:
                          path: /health
                          port: 8096
                          scheme: HTTP
                      initialDelaySeconds: 15
                      periodSeconds: 10
                      successThreshold: 1
                      timeoutSeconds: 1
                  name: jelly
                  ports:
                      - containerPort: 8096
                        name: http
                        protocol: TCP
                  readinessProbe:
                      failureThreshold: 3
                      httpGet:
                          path: /health
                          port: 8096
                          scheme: HTTP
                      initialDelaySeconds: 15
                      periodSeconds: 10
                      successThreshold: 1
                      timeoutSeconds: 1
                  resources:
                      limits:
                          gpu.intel.com/i915: "1"
                          cpu: "12"
                          memory: 4Gi
                      requests:
                          gpu.intel.com/i915: "1"
                          cpu: "1"
                          memory: 4Gi
                  terminationMessagePath: /dev/termination-log
                  terminationMessagePolicy: File
                  volumeMounts:
                      - mountPath: /config
                        mountPropagation: None
                        name: config
                      - mountPath: /media
                        mountPropagation: None
                        name: media
                      - mountPath: /cache
                        name: cache
            dnsPolicy: ClusterFirst
            enableServiceLinks: true
            nodeSelector:
                feature.node.ceph: "true"
                intel.feature.node.kubernetes.io/gpu: "true"
            restartPolicy: Always
            schedulerName: default-scheduler
            securityContext:
                fsGroup: 997
                fsGroupChangePolicy: OnRootMismatch
                seccompProfile:
                  type: RuntimeDefault
            shareProcessNamespace: false
            terminationGracePeriodSeconds: 30
            volumes:
                - persistentVolumeClaim:
                    claimName: jelly-config
                  name: config
                - name: media
                  persistentVolumeClaim:
                      claimName: media-pvc
                - name: cache
                  emptyDir:
                    sizeLimit: 20G

---
apiVersion: v1
kind: Service
metadata:
    labels:
        app: jelly
    name: jelly
    namespace: default
spec:
    internalTrafficPolicy: Cluster
    ipFamilies:
        - IPv4
    ipFamilyPolicy: SingleStack
    ports:
        - name: http
          port: 80
          protocol: TCP
          targetPort: http
    selector:
        app: jelly
    sessionAffinity: None
    type: ClusterIP
