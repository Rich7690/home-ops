---
apiVersion: apps/v1
kind: Deployment
metadata:
    labels:
        app: oauth-proxy-radarr
    name: oauth-proxy-radarr
    namespace: default
spec:
    progressDeadlineSeconds: 600
    replicas: 2
    revisionHistoryLimit: 3
    selector:
        matchLabels:
            app: oauth-proxy-radarr
    strategy:
        rollingUpdate:
            maxSurge: 100%
            maxUnavailable: 0
        type: RollingUpdate
    template:
        metadata:
            labels:
                app: oauth-proxy-radarr
        spec:
            automountServiceAccountToken: true
            serviceAccount: oauth-proxy
            affinity:
                podAntiAffinity:
                    preferredDuringSchedulingIgnoredDuringExecution:
                      - podAffinityTerm:
                            labelSelector:
                              matchExpressions:
                                - key: app
                                  operator: In
                                  values:
                                  - oauth-proxy-radarr
                            topologyKey: kubernetes.io/hostname
                        weight: 100
            containers:
                - envFrom:
                      - secretRef:
                            name: oauth-proxy
                            optional: false
                      - configMapRef:
                            name: oauth-proxy-radarr
                            optional: false
                  image: quay.io/oauth2-proxy/oauth2-proxy:v7.4.0@sha256:f81637250eb3b5d902fba3c4ade3d3b1e34cc7f2350bc30402f1e62adfdf17aa
                  args:
                    - "--set-xauthrequest"
                    - "--tls-cert-file=/certs/tls.crt"
                    - "--tls-key-file=/certs/tls.key"
                    - "--https-address=:8443"
                    - "--skip-auth-route=/api/v3"
                  imagePullPolicy: IfNotPresent
                  livenessProbe:
                      failureThreshold: 3
                      httpGet:
                          path: /ping
                          port: 8443
                          scheme: HTTPS
                      initialDelaySeconds: 5
                      periodSeconds: 10
                      successThreshold: 1
                      timeoutSeconds: 1
                  name: oauth-proxy
                  volumeMounts:
                    - mountPath: /certs
                      name: cert
                  ports:
                      - containerPort: 4180
                        name: http
                        protocol: TCP
                      - containerPort: 8443
                        name: https
                        protocol: TCP
                  readinessProbe:
                      failureThreshold: 3
                      httpGet:
                          path: /ping
                          port: 8443
                          scheme: HTTPS
                      initialDelaySeconds: 5
                      periodSeconds: 10
                      successThreshold: 1
                      timeoutSeconds: 1
                  resources:
                      limits:
                          cpu: '4'
                          memory: 64Mi
                      requests:
                          cpu: 50m
                          memory: 64Mi
                  securityContext:
                      allowPrivilegeEscalation: false
                      capabilities:
                          drop:
                              - ALL
                      privileged: false
                      readOnlyRootFilesystem: true
                      runAsGroup: 65532
                      runAsNonRoot: true
                      runAsUser: 65532
                      seccompProfile:
                        type: RuntimeDefault
                  terminationMessagePath: /dev/termination-log
                  terminationMessagePolicy: File
            dnsPolicy: ClusterFirst
            enableServiceLinks: true
            securityContext:
              seccompProfile:
                type: RuntimeDefault
            nodeSelector:
                kubernetes.io/arch: amd64
            restartPolicy: Always
            schedulerName: default-scheduler
            shareProcessNamespace: false
            terminationGracePeriodSeconds: 30
            volumes:
                - name: cert
                  secret:
                    secretName: prod-me-cert
                    optional: false
---
apiVersion: v1
data:
    #OAUTH2_PROXY_ALLOWED_GROUPS: /admin
    #OAUTH2_PROXY_ALLOWED_ROLE: admin
    OAUTH2_PROXY_COOKIE_EXPIRE: 720h
    OAUTH2_PROXY_COOKIE_SAMESITE: lax
    OAUTH2_PROXY_EMAIL_DOMAINS: '*'
    OAUTH2_PROXY_HTTP_ADDRESS: :4180
    #OAUTH2_PROXY_PROVIDER: keycloak-oidc
    OAUTH2_PROXY_PROVIDER: github
    OAUTH2_PROXY_GITHUB_ORG: rtdev7690
    OAUTH2_PROXY_REVERSE_PROXY: 'true'
    OAUTH2_PROXY_SCOPE: "read:user user:email read:org"
    OAUTH2_PROXY_UPSTREAMS: http://radarr:7878
    #profile email openid
    OAUTH2_PROXY_SET_XAUTHREQUEST: 'true'
kind: ConfigMap
metadata:
    labels:
        app: oauth-proxy-radarr
    name: oauth-proxy-radarr
    namespace: default
---
apiVersion: v1
automountServiceAccountToken: true
kind: ServiceAccount
metadata:
    name: oauth-proxy-radarr
    namespace: default
