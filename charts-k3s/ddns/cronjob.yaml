kind: CronJob
apiVersion: batch/v1
metadata:
  name: ddns
  namespace: default
  labels:
    app: ddns
spec:
  schedule: "@hourly"
  concurrencyPolicy: Forbid
  failedJobsHistoryLimit: 1
  successfulJobsHistoryLimit: 1
  jobTemplate:
    spec:
      backoffLimit: 3
      template:
        spec:
          restartPolicy: Never
          containers:
          - name: ddns
            image: curlimages/curl:8.11.0@sha256:83a505ba2ba62f208ed6e410c268b7b9aa48f0f7b403c8108b9773b44199dbba
            imagePullPolicy: IfNotPresent
            command: ["/bin/ash", "-xec"]
            args: ['curl -i "$PREFIX?h=$DOMAIN&k=$KEY&a=$HOST_IP"']
            env:
            - name: PREFIX
              valueFrom:
                secretKeyRef:
                  name: ddns-config
                  key: prefix
            - name: DOMAIN
              valueFrom:
                secretKeyRef:
                  name: ddns-config
                  key: domain
            - name: KEY
              valueFrom:
                secretKeyRef:
                  name: ddns-config
                  key: key
            - name: HOST_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.hostIP
