apiVersion: apps/v1
kind: Deployment
metadata:
  name: frigate-snap-sync
  labels:
    app.kubernetes.io/name: frigate-snap-sync
    app.kubernetes.io/instance: frigate-snap-sync
spec:
  replicas: 1
  revisionHistoryLimit: 3
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app.kubernetes.io/name: frigate-snap-sync
      app.kubernetes.io/instance: frigate-snap-sync
  template:
    metadata:
      labels:
        app.kubernetes.io/name: frigate-snap-sync
        app.kubernetes.io/instance: frigate-snap-sync
    spec:
      hostUsers: false
      serviceAccountName: frigate-snap-sync
      containers:
        - name: frigate-snap-sync
          image: weikinhuang/rclone-backup:1.72@sha256:b17a25f269a294243764e0d9ec3859a1dea09de85b856821015657c7d75bac89
          command:
            - tini
          args:
            - "--"
            - /files/exporter-loop.sh
          imagePullPolicy: IfNotPresent
          securityContext:
            allowPrivilegeEscalation: false
            seccompProfile:
              type: RuntimeDefault
            readOnlyRootFilesystem: false
            runAsNonRoot: false
            runAsUser: 0
            runAsGroup: 0
          #  capabilities:
          #    drop:
          #      - ALL
          envFrom:
            - secretRef:
                name: frigate-snap-sync-env
                optional: false
          env:
            - name: TZ
              value: "America/Los_Angeles"
          volumeMounts:
            - name: rclone-conf
              mountPath: /config
            - name: rclone-sync-script
              mountPath: /files/exporter-loop.sh
              subPath: exporter-loop.sh
              readOnly: true
            - name: frigate-media
              mountPath: /media/frigate/recordings
              subPath: frigate/recordings
              readOnly: true
            - name: frigate-media
              mountPath: /media/frigate-snap
              subPath: frigate-snap
            - name: tmp
              mountPath: /tmp
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              memory: 1Gi
      volumes:
        - name: rclone-conf
          persistentVolumeClaim:
            claimName: rclone-conf
        - name: rclone-sync-script
          configMap:
            name: rclone-sync-script
            defaultMode: 0755
            items:
              - key: exporter-loop.sh
                path: exporter-loop.sh
        - name: frigate-media
          persistentVolumeClaim:
            claimName: frigate-media
        - name: tmp
          emptyDir: {}
      restartPolicy: Always
      terminationGracePeriodSeconds: 15
