apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
    name: generate-backups
spec:
    background: false
    generateExistingOnPolicyUpdate: true
    rules:
        - name: pvcs
          match:
            any:
                - resources:
                    annotations:
                        home.backup.io: ENC[AES256_GCM,data:veQDww==,iv:RwJqDPUE8KfXFcPlUztR8vnieXiJk5JS0uGcV3j2wHQ=,tag:9XOD+AJRNwxO8RbdzkQoDQ==,type:str]
                    kinds:
                        - PersistentVolumeClaim
          generate:
            synchronize: true
            apiVersion: v1
            kind: Secret
            name: restic-config-{{request.object.metadata.name}}
            # generate the resource in the new namespace
            namespace: '{{request.object.metadata.namespace}}'
            data:
                kind: ENC[AES256_GCM,data:Fxy0MuRU,iv:6L0T+d8f/Ei3bHD4ocd/pkavFg8wvWdN1uC4XtNfcZ0=,tag:IC3KKvia4fAk4k0aXBFPUw==,type:str]
                type: ENC[AES256_GCM,data:vMnJiAU7,iv:Fai61oQv0aCQ02tmVhuZzLtUFbdNuTD893pxpP6MaO4=,tag:4cGVHhFgw8gpdWqY7QPhuA==,type:str]
                stringData:
                    #ENC[AES256_GCM,data:rcPwZ10ePnDvNSCpY5NDfuvoyw==,iv:ew30L8SlrVIm8YWIxU1mbyJr8rKDLJ30tdV0CBHA1rE=,tag:Goq9Tjy3a1eMI2VBJxBdUw==,type:comment]
                    RESTIC_REPOSITORY: ENC[AES256_GCM,data:Vlwg+ORn18M3E2PlZnmChJZbci6k0yg87ycpZ1DymwzoaualuHUnZ66S6b4f9XqA9tCzvHwZ9GU8o3eq+wDaq3I02bUllLUeL55VGWmpJBWvkEtXWrNa/bs=,iv:M5oYZVCFhTH5X77/8RxKaRThqoacodMpZTwNANi8XOs=,tag:LTgF6tdlhm6YHIANiWc6Bw==,type:str]
                    #ENC[AES256_GCM,data:ikJBDcqh69wq2Um5xwfvPC1ZuhHj0cfxerl49XZp,iv:2uKzQS1qjGyp2W7NOhpJ/1kAPdhtMnVkLi66T3gb198=,tag:U23xKLi8+sNVnJ+QkaFbXw==,type:comment]
                    RESTIC_PASSWORD: ENC[AES256_GCM,data:Wxv9HrghXlXXy6KvmJi//A==,iv:CDxCRl6JZFhyQA9LJYxevduiQ1QDyHTVmEsmPAULTok=,tag:ec8+FxixUmeH91cEv8njuA==,type:str]
                    #ENC[AES256_GCM,data:3qXnqI+ihkcP8V3lBJDn9ri/vveGHCtPumudMtK2/QaqXPOEqsI+AlE=,iv:zO8ep4qqQe+ehVCbwJQGj20o+7QZ5yZa9EHTSxaE0YY=,tag:Rqh1DeeN2kuTpT3v/Ur47g==,type:comment]
                    #ENC[AES256_GCM,data:MQlfZcVo6GLCbA9rCamPaAhNBDIvdek9czXMMdV0euk9sP9vdCzU6yR/lbei2Pztyh0lOc8Mhj7gfvc02Fq09JfTvgpqpw==,iv:QrpkW5fDGHvR1VB8V+T7IWR+I73SlYT0UZWhH+tqWvs=,tag:dZym+TFu9JUoL0wQTqD36Q==,type:comment]
                    AWS_ACCESS_KEY_ID: ENC[AES256_GCM,data:1Sv6V8uRABsuTFYqTFA2ROZrf/A0I0xGWw==,iv:vohgi86NO3u1lResO4C33nsXiGLN+GK5UzMKcNOx1oI=,tag:vDUF9ESgBesrHuqyxqEH8w==,type:str]
                    AWS_SECRET_ACCESS_KEY: ENC[AES256_GCM,data:kY6gkVR0nqaPUpQD0T+GE2AhVawucVGXhxQe0MixIA==,iv:pAF44fAgRaT1/KHI6l51aejr2N+hI7C/QlwUMD9rfkI=,tag:H83MVvVBtfmGXQzLBw4HjQ==,type:str]
                    RESTIC_COMPRESSION: ENC[AES256_GCM,data:yN+0RQ==,iv:bdU2IqRoxJeD0piZFKFN5Gd1uPZQgcCKTaJTJCbdI+k=,tag:i6nonTDPAWuvTwj+C3Gbdw==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age17pzq63nanwarvma9nc7dvp7yy3dalgcr8e958dxrx9nfkkcwuyksw8qsds
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSByRk5WOTN6V1ljRUo2ZnY1
            amxMdFBURFRDM0hERStPbzFHbnFQNDU0SDFZCkdtK0habGI4WCtIVnRlWGc2SmRL
            RDRSdTZBejBUNHBlQ3RjRTNZMmxsYWsKLS0tIFhuKzF1amF4U1R2UVZXRlVZQmx1
            ckxFeldlVDM0NHhMMGRwNlpPQjhORGsKELySR+AGz/riXWVHiUVhpnLgQ/LOAmZO
            XGmwKCnCJOrM0Trk/K9G8kYnSGL5lb+SSB/CMEfmsk1Qw8Ve/hZrDw==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2023-09-24T22:01:01Z"
    mac: ENC[AES256_GCM,data:f/ULsynchldJAeTPFKtSJ3iRNtCDc5myeKaqF7LY0LmqIAc8R8hpOZ9yqfRXIq9bstFkT7nw5o8TjktHIUIy7fo53mmpSBx4wHv0HoH0SfYHqpm9eymDR7xowGIB6r3aMvKOWP6krOboCpcJLh3+sH3Jfh5ogxxiAdF5TUf0kE0=,iv:6hBtKSH2ocZsBx1jcrFITNxrsDPvJsQ+QL0vQDH+nHY=,tag:yW5ONnS8wnZRbQM4TSKGpw==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData|host|hosts|values|annotations)$
    version: 3.7.3
---
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
    name: generate-backup-rs
spec:
    background: true
    generateExistingOnPolicyUpdate: true
    rules:
        - name: pvcs
          match:
            any:
                - resources:
                    annotations:
                        backup_schedule: ENC[AES256_GCM,data:KQ==,iv:d6CKLihoWqjb81JwTZtaWcQDcZIZ2us5U2ZEMsm5r/o=,tag:d/r228a0x7jqymTjgAN+2g==,type:str]
                        home.backup.io: ENC[AES256_GCM,data:1DWDGg==,iv:WA+Ym1ffbjg45+WEoYYAqtzxOJTHP5Jzd1/LKrioWYI=,tag:saH9yxsPHzS9hkIUT+URbA==,type:str]
                    kinds:
                        - PersistentVolumeClaim
          generate:
            synchronize: true
            apiVersion: volsync.backube/v1alpha1
            kind: ReplicationSource
            name: '{{request.object.metadata.name}}-backup'
            # generate the resource in the new namespace
            namespace: '{{request.object.metadata.namespace}}'
            data:
                kind: ENC[AES256_GCM,data:DaKWKqsTRJDz/NPcCXeVkpg=,iv:QKLfSXBkKfFL0NvO1mX9qXdTGIV7pI0iyhY9Okf4DhM=,tag:x9/XPmhx9mf89ZnfmhOCQA==,type:str]
                spec:
                    #ENC[AES256_GCM,data:vfeCwlhTJjkiFPNsRd8uOUbdixwN/8uO,iv:N9Kcnco0dCgVERJ3INykZIR1uCN88L0Hp+QeF0yZ2Rc=,tag:kyZCcnLUtSkgvyLuWokrfA==,type:comment]
                    sourcePVC: ENC[AES256_GCM,data:VK3kb2b6by6m6qnOGkKgSgVQ0/WoXKKpHuCEd1Qk3q8=,iv:ox647RtDVhlQqUyQINLmAniP6QIRRnxXHRGFM85OeRc=,tag:VaclHm2rqfVI3IuxVmoNqg==,type:str]
                    trigger:
                        #ENC[AES256_GCM,data:mvwJOLj0/H6Pfjsdl3YrrqKiMeB9JifIBU4O8npkyQ==,iv:KPszKcMSCBqlSx31DycDyOo9VLwfJILV7OI3AnK/3Vk=,tag:sOFjwIwBO4Kfl5Jx0SGrzA==,type:comment]
                        schedule: ENC[AES256_GCM,data:sKrkyfn5sM4ppk5X6iUJq6SuFUv3QpMb1Rtk5cJ6HQPE+YeiH5GpZ9QuWZYC3jeN1SfwcEyalQ==,iv:26BJCbnmaPkFMKckzWmO5J5fHS+EM0l6FseH25X0Ros=,tag:B80t7giL22iDgY2Nf+ZPZA==,type:str]
                    restic:
                        #ENC[AES256_GCM,data:wsz9oRVv8HKBRvWJwWKO823yuvHKwanGQucoLP7KOqw3u/Vuk/kIBGUFM7mYKHifoWB25O27OpzgRw==,iv:3bJvIm+bms198QHW0ANbns2pEGhoGkTDuyBBMMOC9Kc=,tag:WmiEucTEPkwyjqvHzPywEw==,type:comment]
                        pruneIntervalDays: ENC[AES256_GCM,data:aSo=,iv:zN+BFV7lU4L6PfFD6B2KyyhbS+U9xGDmLGtzHEtfCEE=,tag:aCxvaWiKn4+Y8s3WuLrgjw==,type:int]
                        #ENC[AES256_GCM,data:L/5wLWR1ld8IE+5qG13iAO7Chb9pBsl1Rbp+hg1T5LeaF/5LoU9k5xvLp0V6Dhl7rTPU,iv:86P2ANK7yRjCQit9YZ0QaKgJKMQt9k4mTnGQqK2yhTc=,tag:S7OnflygiptpUZFzlrCoZQ==,type:comment]
                        repository: ENC[AES256_GCM,data:syldNu0737cXaSIyst09aFYqpuqhktp3GdJhFCagxs3p4PJfHVLZC5rnmbrBjg==,iv:Y9knGsz1HA3nhs4uKtSpspWuNQrUQLZmhSkx2P82KpE=,tag:X7vElnZl0MMfuA+pRaWypg==,type:str]
                        #ENC[AES256_GCM,data:n/WZYArd1d4oJ7oQoJDXtbseudV0juy9HAnRhCc=,iv:PmgTZJ1H5o4T7vnmXWy6K6FWXla7Ibqsdce4mVt1VL8=,tag:GfvfXNaObRmNuBYDjgJYRg==,type:comment]
                        retain:
                            hourly: ENC[AES256_GCM,data:FQ==,iv:eO7c5stStVzn9TujAWDGjEOto2LEiS8O7Z2ZAMcCGa0=,tag:w8XCBgRx/XCZhycR/7ccBw==,type:int]
                            daily: ENC[AES256_GCM,data:Bg==,iv:xayUjQ4ey0E0Kv7HhvKKfNE3CTkoX4/ZRtRT5PVEnwc=,tag:bfgPmQUWpT5AbDjQk9lzvw==,type:int]
                            weekly: ENC[AES256_GCM,data:tA==,iv:vt5ddVUR+0yhI0MvcCsGw5lVx0kLx8wRv40gAkLvpwQ=,tag:T6x7t6lHuhuVIDwK2yD2kg==,type:int]
                            monthly: ENC[AES256_GCM,data:Aw==,iv:kQ5e8+P9FtmuRjgt1HCHNeYpxLLWjbCYrzUGZbDVOn0=,tag:KTa3vaEHdZmKpEUJnqg87g==,type:int]
                            yearly: ENC[AES256_GCM,data:5w==,iv:iJgjJx56wdfWxjR+oyTaMzbUe2sRXGhoF2jXIb01pDo=,tag:TO7hFK+8nvce6HH0N6CvJA==,type:int]
                        #ENC[AES256_GCM,data:V7QrqlmSxCvpRd6FDWBBCZXUCr9EyAoS5eh2KQzfI1urcSRi0Fw9Uj053ZmJAG+S5RrSYMNNtNPgn8NvNA==,iv:TH2iAtnt9BvOhu8vcyJeL44gpCJz3GmiLwtZl+gbDWw=,tag:rQZgnyM7Wiiw/WNakHiAgg==,type:comment]
                        #ENC[AES256_GCM,data:1YgvEIGK5VZxgP47L+QsNH7xesGP,iv:XOPgu3JxfVoThIF5DTEm3x4rvsJbOr6n1sai6OBoGV8=,tag:C5agj4DNBwigBbWXbUDHCw==,type:comment]
                        copyMethod: ENC[AES256_GCM,data:o/zyequ/2dI=,iv:QXycc7HDPQH2giuFmQcgobaKNF8vGm7r3T25JMp+VMo=,tag:gJi557xOZ06nM1R0v6pz0Q==,type:str]
                        #ENC[AES256_GCM,data:AcFUhzEEuo46BYsVR7yQXM7iFOFfD/Uk+C/gifWyzJkqegxOQrXOTUZydgUC+1r/B9YGCPPeRwsb3bCeTKYGkM2sByhHPhEtPAqFccUQ15YZxZo=,iv:x/LaY8aadWEKfmgPMDAYdTolqGoGcWT8KSvfv9niqY4=,tag:TF7ptX0SUuUWt6W08F/9Yw==,type:comment]
                        #ENC[AES256_GCM,data:i4SDzWbK4S9fo+G2qqzNrae1nryNQutYBo9aaw==,iv:Px47h8Bq6zo/BA1rQq39jGJnFRQftBnAHZUrFJ0WGbA=,tag:yIm7wBh+s15gFapYb4unHg==,type:comment]
                        #ENC[AES256_GCM,data:jBKPM+VlPiNbJd4siOJ4oDl29G1ZXiXZi22UiiUenn+YxxdpKaX8CNnApbvyZ9Jmv8GaDjnFhJuUkWOFyXpQVuT0VQ==,iv:jFS1GQ97wx61adfkA7YD7c6HsAM5h+O0hhru11Y7FG4=,tag:pBBafRWe2Kq9RT1GYognsQ==,type:comment]
                        volumeSnapshotClassName: ENC[AES256_GCM,data:aoVTuWaVm5otINlDK1lLYJE9H4L7ZB4=,iv:4EvWViBevpsKCjzhZK9UtQkp9bFtv20MOzgE0vM/l8Q=,tag:b8F9hdM2gfddeqXejAdq/Q==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age17pzq63nanwarvma9nc7dvp7yy3dalgcr8e958dxrx9nfkkcwuyksw8qsds
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSByRk5WOTN6V1ljRUo2ZnY1
            amxMdFBURFRDM0hERStPbzFHbnFQNDU0SDFZCkdtK0habGI4WCtIVnRlWGc2SmRL
            RDRSdTZBejBUNHBlQ3RjRTNZMmxsYWsKLS0tIFhuKzF1amF4U1R2UVZXRlVZQmx1
            ckxFeldlVDM0NHhMMGRwNlpPQjhORGsKELySR+AGz/riXWVHiUVhpnLgQ/LOAmZO
            XGmwKCnCJOrM0Trk/K9G8kYnSGL5lb+SSB/CMEfmsk1Qw8Ve/hZrDw==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2023-09-24T22:01:01Z"
    mac: ENC[AES256_GCM,data:f/ULsynchldJAeTPFKtSJ3iRNtCDc5myeKaqF7LY0LmqIAc8R8hpOZ9yqfRXIq9bstFkT7nw5o8TjktHIUIy7fo53mmpSBx4wHv0HoH0SfYHqpm9eymDR7xowGIB6r3aMvKOWP6krOboCpcJLh3+sH3Jfh5ogxxiAdF5TUf0kE0=,iv:6hBtKSH2ocZsBx1jcrFITNxrsDPvJsQ+QL0vQDH+nHY=,tag:yW5ONnS8wnZRbQM4TSKGpw==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData|host|hosts|values|annotations)$
    version: 3.7.3
