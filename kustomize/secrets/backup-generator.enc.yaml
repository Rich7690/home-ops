apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
    name: generate-backups
spec:
    background: true
    generateExistingOnPolicyUpdate: true
    rules:
        - name: pvcs
          match:
            any:
                - resources:
                    annotations:
                        home.backup.io: ENC[AES256_GCM,data:xKpYKQ==,iv:1h/KmtZQKSL7PgVmHsMHXO/qK62Y+O5hljd9hJL/v38=,tag:S2LQAoeJRJJcub48GTRE3g==,type:str]
                    kinds:
                        - PersistentVolumeClaim
          generate:
            synchronize: true
            apiVersion: v1
            kind: Secret
            name: restic-config-{{request.object.metadata.name}}
            # generate the resource in the new namespace
            namespace: '{{request.object.metadata.namespace}}'
            data:
                kind: ENC[AES256_GCM,data:FOP1fNMw,iv:yi2dyrxFKISq5PzphADxxL6vugb2j5TrUmBpyKTMaGY=,tag:atUKOgNhU1yv3iouwrjUdQ==,type:str]
                type: ENC[AES256_GCM,data:Hjr6c3wA,iv:WMIkkJzq1N2U6C12tYEXduWMKAFTrZkKjnVDQceEpyA=,tag:+/4ad0/QC/A78upoM1/UQg==,type:str]
                stringData:
                    #ENC[AES256_GCM,data:6YA5arQp/XCFw9Q6IlUihkelEA==,iv:vFTzeIeVfeUT7ZyeLZKjT5NCaAYgESCA2CfQ3l26jis=,tag:aTBGrQdgpOnM0RLCcvzX0Q==,type:comment]
                    RESTIC_REPOSITORY: ENC[AES256_GCM,data:O1TJfE+DUwyoM1VCyJv2lGznqWdtrXE/kdbBeVFec5CKvb1n22KMJ1oCc6Vnvn4YGEFX8h7lZOChpoqnaRRjZpwqrf6jlzRfxol8xV4XmWVIDKcLjgjRfKI=,iv:631Mt/HJnCislzwR+DUCUsGuVEwfK/EueEF2IOrRvS4=,tag:03KyoqNZE5vTDqOlWKS2zw==,type:str]
                    #ENC[AES256_GCM,data:CHOaox09ByFMNLtc6akDvh1SUCaC6Yvjwk6ivPsT,iv:UYzjyifQJCIAdNlUPBIy4vY40p1wY+jmrrBnJnfLwPc=,tag:ocNPGDhX/U2EydvLCgqUzg==,type:comment]
                    RESTIC_PASSWORD: ENC[AES256_GCM,data:S6jJlENeDC2nhw4hwTL5Rw==,iv:KrDZJMoa+Jeyd6v8/T1rSv/f1jTI3nwzuGk/SkQOUes=,tag:uEcd62TE/SBAk07GGcyGAA==,type:str]
                    #ENC[AES256_GCM,data:sVTtdrk1g8NgtM+rfDcsbmudRw+c7F0DTFMqI2mB7yk/s0AHS1LyuTQ=,iv:aUOQvwe1jIn8wKZvmog01sbkpEmSADGWiUrVp5lIH8A=,tag:2BEraiewdI/5lnNH/z3vog==,type:comment]
                    #ENC[AES256_GCM,data:Cn73YsI18ah+ohsInedZuP5+78vwebqTB4ghXEwH5UiE83mtcWLlemWs8v9R4jjA30E+7a3+0BuHTrXbzn8Hol/36svAxg==,iv:OgV/pDwTHMF0Gdc1whZ5SL94s1FSZCYbhP/nn9BBk6w=,tag:JW8RPkK89SewkYfTAoKK/Q==,type:comment]
                    AWS_ACCESS_KEY_ID: ENC[AES256_GCM,data:pDvGiaM2922/t9qU/Dq6N9V2i6nwE8sc1g==,iv:Bw5iqP43b2xKaMomp2f4xKrKp5jEQDw3G/GtGnNmvs8=,tag:dJ0uS9yakQyiOTQ13li0bw==,type:str]
                    AWS_SECRET_ACCESS_KEY: ENC[AES256_GCM,data:VkSG6316BuTm7YaucnnX8gQ7C63pMmUN/w5Z1QkQ7Q==,iv:b44qFLi5paNIQu6obqx3j44GTHspRNdGXXnH2OnLmVg=,tag:QAuSgcALBbAd8t4vcBE3SQ==,type:str]
                    RESTIC_COMPRESSION: ENC[AES256_GCM,data:gpTPxA==,iv:MSI7pzzfZ1nrKn/m+7yBGajjLJ05i1oV4+AJe8jK7Cc=,tag:jVccEmaWNWrhRHwbrZWy/w==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age17pzq63nanwarvma9nc7dvp7yy3dalgcr8e958dxrx9nfkkcwuyksw8qsds
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBqamVhV1oweGpsbHk3cVNk
            VStXR1pldUorRFh3Ykl5eXZQRmZTZUowMXlRCmJLME5YZjQrSWZLZ1ZLMWY2MXM1
            VVc0RnZTYXlRYk1HVzRtUE5jNGhoN2sKLS0tIC91eFdwb0FxMGVoVzZXV29KWmpz
            STViSVAwVmhVZks2Uk5RdGJSZEtXSEkKtAdMyIsjNWlVXJj71FIoNcApfDy2fciu
            xw4mAK7B/WD73x2kDELeERFO4T5K4RG7lqmBBBHgw0iov0ZKW7omwg==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2023-09-24T22:31:20Z"
    mac: ENC[AES256_GCM,data:M0XCfWa/B0FqhMzQWD/XqLSdakemI54lVfU3rMw7C6ky9Yiq9MU0JXTfgpBvVLqUg/GDsDGmTZZv+pu4kiwN6qAP50807HOHh6OAhxutzhA1kJ/vZs6TaXKxFBw1jMgv9gVUMqH99bsxWIyCY1TXXm5gV7SArUTWvRie+cK0Mdc=,iv:uLvMvrM99v5FJH7QSyRxeYS0CYwT4pmwX5cjAojdUwY=,tag:FAiSl5GWJCef4UxSQXHkJw==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData|host|hosts|values|annotations)$
    version: 3.7.3
---
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
    name: generate-backup-rs
spec:
    background: true
    generateExistingOnPolicyUpdate: true
    rules:
        - name: pvcs
          match:
            any:
                - resources:
                    annotations:
                        backup_schedule: ENC[AES256_GCM,data:xA==,iv:wu62PhrOmPRgaq9UmltoYVlZnFCPtNgLPIeLQYr4+qc=,tag:GeI5D/D6SHvSDaTrLf7vUg==,type:str]
                        home.backup.io: ENC[AES256_GCM,data:vRC/4g==,iv:L9htAY8HdyBqiyk4lEKKpMz6f+G1pfSE5tEkhDwSG00=,tag:K6VelYo0XsYQOw4w3BYheA==,type:str]
                    kinds:
                        - PersistentVolumeClaim
          generate:
            synchronize: true
            apiVersion: volsync.backube/v1alpha1
            kind: ReplicationSource
            name: '{{request.object.metadata.name}}-backup'
            # generate the resource in the new namespace
            namespace: '{{request.object.metadata.namespace}}'
            data:
                kind: ENC[AES256_GCM,data:U0kWFfB3p4mdhiq1aZrWI3U=,iv:a7S2855dd0N1bSUXfuq2URpIVqx2iQrUkqfX9gF8V04=,tag:9/fNTcSVFjRzWVzQvCGsNg==,type:str]
                spec:
                    #ENC[AES256_GCM,data:FHWn0+12F00oae0Z8/Bx6iVtf+r2Xpud,iv:h0vaMemxDmMqDAPGf0GjlSxzVtA8K40OcPR1js7ux5w=,tag:zSAU9lMPQBzVdMxsmd+Fww==,type:comment]
                    sourcePVC: ENC[AES256_GCM,data:XAmR9sbD3WZbV+A7wHyRWCra01dvbTLPSI9dk64tIfU=,iv:+VZavRr20b5rWFYaaOdWmz2Gv7ZATDLs+u0X2pZvA9w=,tag:goTj1YB0k1ryyKx4mGRrAQ==,type:str]
                    trigger:
                        #ENC[AES256_GCM,data:wFFL3miiDpoyALvjDinD7F12eFxfGmu9Syveyz2Fzw==,iv:R+XZwGIitsaou+icw0RwphuEI1YsmRGtVN55ZhJSuPQ=,tag:oTFvMcfrt04Rn3jbHgkeow==,type:comment]
                        schedule: ENC[AES256_GCM,data:juhAREjFZRC3pjEbd2NwlcrQlBTjI/7QAWMfgFUyvPfHQbbPttPRvB+wiJr3vulskvWZwE2lRQ==,iv:MC9YUoMWu/xgY/kMwU9YKGsrm9ryDfT7ACEgP0tUQ5M=,tag:aV1X8K5tuad/FOsRPHi6Ew==,type:str]
                    restic:
                        #ENC[AES256_GCM,data:jO97wwLvGLo2RruOhciOAKJVS4HT0MhlMRLxE1CC3YFBtUVlqSaFNkIisVAR07g/MSo9vzCU+CKkIg==,iv:50tZSmYhuAyQo5+5ETebI4i4AYjwt8KNXYMfI6asRg0=,tag:NJkQ/vksLJpf0DvQt2QJAw==,type:comment]
                        pruneIntervalDays: ENC[AES256_GCM,data:VpI=,iv:i5KN1STuUtLWMICmcS/FttOXsaKxqv5412HfNoRX12g=,tag:J5R+gf819Y2WReYM5oakvg==,type:int]
                        #ENC[AES256_GCM,data:yQnH9RLqSpSf+qWlD/uazTf6KAplW1oMpUdotcWlI24XlXEOozdiP1dHd3G7IPJdVbZM,iv:VDGzkqYk7pUGB/Ox9m6L1aUz4K/t6YflNtBjH0u1gfE=,tag:W796YSOh+eNN2Z7FeCRJ3Q==,type:comment]
                        repository: ENC[AES256_GCM,data:Ihf/xqwcFxO36RPJicgKUSkRwToapFEWv1eecogMBR6Lm10k4hk9MaYBnXl6ew==,iv:aYVcBHAw/6hDM/eTCjesA1bQNzf51UtMMxL3VKsCiYM=,tag:5OGDTekvk5f6/KfdU9uMmA==,type:str]
                        #ENC[AES256_GCM,data:BTrX9lyGnANzcdYPA5Zt34UQ2Sn3Z91XoTrjdsU=,iv:RrGhSfsJsA0oWUb8rATuxG46L1wbH69S7OMUjSaqdW0=,tag:P2haP2xk9bHepcAwoGvyGQ==,type:comment]
                        retain:
                            hourly: ENC[AES256_GCM,data:PQ==,iv:Rk5LVTFHnzb+5cXE+2qeGdXqhHL+vOPogocwibYoPHM=,tag:Zk1SXFydIw+A+MwiFdpjlA==,type:int]
                            daily: ENC[AES256_GCM,data:fA==,iv:VMPeb6RMvOk5MVAkNEJXATEGjhQkrb43Dm3YCeg2bB4=,tag:jgQSm4kJSfit4xHJBuksBQ==,type:int]
                            weekly: ENC[AES256_GCM,data:oA==,iv:fgZDGVSSv9FX4xQyihzkmU+F1DhAW3xmNeZ9M1JtCXw=,tag:cqbeh1pBk7x3t9YIKXvyWg==,type:int]
                            monthly: ENC[AES256_GCM,data:Bg==,iv:FxfxlPcuYWQz1CO1f4JdnmBFhwhGEOp07Z/mOIFcYVE=,tag:rAzMzuZsJmKMzIunwOx5Ew==,type:int]
                            yearly: ENC[AES256_GCM,data:1Q==,iv:R/AWXKzzdqgn9+qLsONdnBRUc6V5XFf2KSXss+I4REY=,tag:XrJiucUi+VMVGGO430oh4g==,type:int]
                        #ENC[AES256_GCM,data:xA8Bl4kNytkeM0J44GsjhuOpJOgDHsv8+GVgvNUxyIX50mDpB3ScQzbUEPSR3WWU9+J11GnOgcs+8xecFg==,iv:C3a4vKoweESvyxu621V5Q4h2kT9gPkxzawq6iuQ1UbY=,tag:1A2N6YhYZ0c1190zhwrD0w==,type:comment]
                        #ENC[AES256_GCM,data:8R7+b0+2DilfA032ovT+Sce6CPJj,iv:/qp9kzDA8ZTnQEhOPkCqd7xrOa5s2ebV0gLU+i0Ur1A=,tag:8TuKoRyuXemaqgildZAAow==,type:comment]
                        copyMethod: ENC[AES256_GCM,data:SbDZimhGo7o=,iv:o39ek38agw/HVKtnit0HEvX3DN7rxTvGgCW5HwZUDUA=,tag:SzcIqykwsy3yhztYuPiWjw==,type:str]
                        #ENC[AES256_GCM,data:Kvv9zdSgzTEyz5jPl78AieyhCoiRI81n6uu/zkIvC9uRq3csk3wD/P6elFWVUR6kG6qrflR1tAGZUWWTnksaUTA2825w8JT6/h9zh39FuLugSvs=,iv:L6fWuoyiOz2AIqvMiQxkg96zyos76ULx8GC81rL9TN0=,tag:EUVeMoGo0FZi7K74+4fp1w==,type:comment]
                        #ENC[AES256_GCM,data:dY5ZCVPKr+x1i6fbzsP9yajnifUHGrDF5DgEnA==,iv:Eg8BKygvneu8o+hfNdcaLJMT18Nig09cP0AHFi8USlw=,tag:dOk1hFVpmDmyNSc6N0uR8w==,type:comment]
                        #ENC[AES256_GCM,data:4+S/lo7MMQ4Cko6rqzyIytbu+Gvi4M4VlFWOmPX1TRUJo7zyZrW3SoVBzrwg3hTRfMS0YQNznOu1yfdBwTvYhtpsJQ==,iv:6sjMcoWkBpnaDZ5znw3JPd3KSo1CxhsHiANSH7sJ5nw=,tag:QjaaCM4yCQoBdk2bxyaalQ==,type:comment]
                        volumeSnapshotClassName: ENC[AES256_GCM,data:fAQ+lNvdS21I2o2Ky/Pa6JeJsshHlak=,iv:63GGCQYiYWgH53j80oAmgur7Jzq6TNAKhWf8cmpnV6U=,tag:lWhj28e0MMTmsQjgjjwtBA==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age17pzq63nanwarvma9nc7dvp7yy3dalgcr8e958dxrx9nfkkcwuyksw8qsds
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBqamVhV1oweGpsbHk3cVNk
            VStXR1pldUorRFh3Ykl5eXZQRmZTZUowMXlRCmJLME5YZjQrSWZLZ1ZLMWY2MXM1
            VVc0RnZTYXlRYk1HVzRtUE5jNGhoN2sKLS0tIC91eFdwb0FxMGVoVzZXV29KWmpz
            STViSVAwVmhVZks2Uk5RdGJSZEtXSEkKtAdMyIsjNWlVXJj71FIoNcApfDy2fciu
            xw4mAK7B/WD73x2kDELeERFO4T5K4RG7lqmBBBHgw0iov0ZKW7omwg==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2023-09-24T22:31:20Z"
    mac: ENC[AES256_GCM,data:M0XCfWa/B0FqhMzQWD/XqLSdakemI54lVfU3rMw7C6ky9Yiq9MU0JXTfgpBvVLqUg/GDsDGmTZZv+pu4kiwN6qAP50807HOHh6OAhxutzhA1kJ/vZs6TaXKxFBw1jMgv9gVUMqH99bsxWIyCY1TXXm5gV7SArUTWvRie+cK0Mdc=,iv:uLvMvrM99v5FJH7QSyRxeYS0CYwT4pmwX5cjAojdUwY=,tag:FAiSl5GWJCef4UxSQXHkJw==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData|host|hosts|values|annotations)$
    version: 3.7.3
