qbittorrent:
  global:
    fullnameOverride: qbittorrent
  podAnnotations:
    kyverno-skip: "true"
  controller:
    type: statefulset
    podManagementPolicy: Parallel
  addons:
    vpn:
      configFileSecret: vpn-config
      enabled: true
      env:
        KILLSWITCH: "true"
        KILLSWITCH_EXCLUDEDNETWORKS_IPV4: 10.42.0.0/16;10.43.0.0/16
        TZ: America/Los_Angeles
        IPTABLES_BACKEND: nft
      networkPolicy:
        egress:
          - ports:
              - port: 51820
                protocol: UDP
            to:
              - ipBlock:
                  cidr: 0.0.0.0/0
          - to:
              - namespaceSelector: {}
        enabled: false
      # livenessProbe: TODO: fix this
      #   exec:
      #     command:
      #       - sh
      #       - -c
      #       - "if [ $(curl -s https://ipinfo.io/country) = 'CA' ]; then exit 0; else exit 1; fi"
        # initialDelaySeconds: 30
        # periodSeconds: 60
        # failureThreshold: 3
        # successThreshold: 1
      scripts:
        down: |-
          #!/bin/bash
          set -xe
          echo "disconnected" > /shared/vpnstatus
        up: |-
          #!/bin/bash
          set -xe
          echo "connected" > /shared/vpnstatus
      wireguard:
        image:
          repository: ghcr.io/k8s-at-home/wireguard
          pullPolicy: IfNotPresent
          tag: v1.0.20210914@sha256:2ae1aeeba8db0bddffe85582dd35cfcbc952562bfdd57cb7b8b866e89322a33e
      securityContext:
        runAsUser: 568
        runAsGroup: 568
        privileged: true
        capabilities:
          add: ["NET_ADMIN", "SYS_MODULE", "CAP_AUDIT_WRITE"]
      type: wireguard
  env:
    QBITTORRENT__BT_PORT: "58118"
    QBITTORRENT__PORT: "8080"
    UMASK: "022"
    WAIT_FOR_VPN: "true"
    TZ: America/Los_Angeles
  image:
    pullPolicy: IfNotPresent
    repository: ghcr.io/onedr0p/qbittorrent
    tag: 4.5.0@sha256:d02eecc1d4ba992f6523755fde2e29958f218bd3428030b0e6c28c6036ecd52a
  persistence:
    config:
      enabled: true
      mountPath: /config
      type: pvc
      retain: true
    media:
      enabled: true
      mountPath: /media
      accessMode: ReadWriteMany
      size: 10G
      type: pvc
    shared:
      enabled: true
      mountPath: /shared
      type: emptyDir
  securityContext:
    runAsGroup: 568
    runAsUser: 586
